<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Items - Tally Software</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: #f0f2f5;
      }
      .navbar {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .nav-link.active {
        color: #5e35b1 !important;
        font-weight: 500;
        border-bottom: 2px solid #5e35b1;
      }

      /* KPI Cards */
      .kpi-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #5e35b1;
        transition: transform 0.2s;
      }
      .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .kpi-value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
      }
      .kpi-label {
        font-size: 13px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .content-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }
      .table thead th {
        font-weight: 600;
        color: #555;
        background: #f8f9fa;
        border-bottom: 2px solid #eee;
      }
    </style>
  </head>
  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top px-4">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-wallet2 text-primary fs-3 me-2"></i>
        <span class="fw-bold text-primary">Zen Migration</span>
      </a>
      <div class="collapse navbar-collapse ms-4">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item me-3">
            <a class="nav-link" href="/ledgers">
              <i class="bi bi-journal-text me-1"></i> Ledgers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/items">
              <i class="bi bi-box-seam me-1"></i> Items
            </a>
          </li>
          <li class="nav-item me-3">
            <a class="nav-link" href="/journals">
              <i class="bi bi-journal-bookmark me-1"></i> Journals
            </a>
          </li>
          <li class="nav-item me-3">
            <a class="nav-link" href="/invoices">
              <i class="bi bi-receipt me-1"></i> Invoices
            </a>
          </li>
          <li class="nav-item me-3">
            <a class="nav-link" href="/bills">
              <i class="bi bi-file-earmark-text me-1"></i> Bills
            </a>
          </li>
          <li class="nav-item me-3">
            <a class="nav-link" href="/receipts">
              <i class="bi bi-cash-coin me-1"></i> Payment Received
            </a>
          </li>
          <li class="nav-item me-3">
            <a class="nav-link" href="/sales_orders">
              <i class="bi bi-cart-check me-1"></i> Sales Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/purchase_orders">
              <i class="bi bi-bag-check me-1"></i> Purchase Orders
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container-fluid py-4 px-4">
      <!-- HEADER & ACTIONS -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h4 class="fw-bold mb-1">Items Inventory</h4>
          <p class="text-muted small mb-0">
            Manage stock items, HSN codes, and pricing
          </p>
        </div>
        <div class="d-flex gap-2">
          <button
            onclick="syncZoho()"
            class="btn btn-outline-primary d-flex align-items-center"
          >
            <i class="bi bi-arrow-repeat me-2"></i> Sync to Zoho
          </button>
          <button
            onclick="fetchData()"
            class="btn btn-primary d-flex align-items-center"
          >
            <i class="bi bi-cloud-download me-2"></i> Import All Items
          </button>
        </div>
      </div>

      <!-- KPI CARDS -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="kpi-card" style="border-color: #5e35b1">
            <div class="kpi-label">Total Items</div>
            <div class="kpi-value" id="total-items">0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi-card" style="border-color: #1e88e5">
            <div class="kpi-label">Categories</div>
            <div class="kpi-value" id="total-categories">0</div>
          </div>
        </div>
        <!-- Stock Value Card - DISABLED as requested -->
        <div class="col-md-4">
          <div class="kpi-card" style="border-color: #43a047">
            <div class="kpi-label">Stock Value</div>
            <div class="kpi-value" id="total-value">₹0</div>
          </div>
        </div>
       
      </div>

      <!-- CONTENT -->
      <div class="content-card">
        <div class="p-3 border-bottom bg-light d-flex justify-content-between">
          <div class="input-group" style="max-width: 300px">
            <span class="input-group-text bg-white border-end-0"
              ><i class="bi bi-search text-muted"></i
            ></span>
            <input
              type="text"
              id="searchInput"
              class="form-control border-start-0 ps-0"
              placeholder="Search items..."
              onkeyup="handleSearch()"
            />
          </div>
        </div>

        <div class="table-responsive" style="max-height: 600px">
          <table class="table table-hover align-middle mb-0">
            <thead class="sticky-top">
              <tr>
                <th>Item Name</th>
                <th>Group</th>
                <th>Category</th>
                <th>HSN/SAC</th>
                <th>GST %</th>
                <th>Duty %</th>
                <th>Stock</th>
                <th class="text-end">Value</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="8" class="text-center py-5 text-muted">
                  <i class="bi bi-box-seam fs-1 mb-2"></i><br />
                  Click "Import All Items" to fetch data
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OFF CANVAS FOR DETAILS -->
    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="detailOffcanvas"
      style="width: 500px"
    >
      <div class="offcanvas-header bg-light border-bottom">
        <h5 class="offcanvas-title fw-bold" id="offcanvasLabel">
          Item Details
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body" id="offcanvasBody">
        <!-- Details loaded here -->
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let allItems = [];
      let stats = {};


      // Load data on startup
      document.addEventListener("DOMContentLoaded", () => {
          loadFromDB();
      });

      async function loadFromDB() {
          try {
              const res = await fetch('/api/db/items');
              const data = await res.json();
              
              if (data.items) {
                  allItems = data.items;
                  stats = {
                      total_items: data.items.length,
                      categories: new Set(data.items.map(i => i.group_name || i.group)).size,
                      total_value: data.items.reduce((sum, i) => sum + (parseFloat(i.value) || 0), 0)
                  };
                  updateKPIs(stats);
                  renderTable(allItems);
              }
          } catch (err) {
              console.error("Failed to load from DB", err);
          }
      }

      async function fetchData() {
        const btn = document.querySelector(".btn-primary");
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span> Importing...';

        try {
          const res = await fetch("/api/items/fetch");
          const data = await res.json();

          if (data.error) {
            alert("Error: " + data.error);
            return;
          }

          allItems = data.items;
          stats = data.stats;
          // localStorage.setItem("itemsData", JSON.stringify(data)); // No longer needed as primary

          updateKPIs(stats);
          renderTable(allItems);
        } catch (err) {
          console.error(err);
          alert("Connection Error");
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      async function syncZoho() {
        if (
          !confirm("This will sync ALL fetched items to Zoho Books. Continue?")
        )
          return;

        const btn = document.querySelector(".btn-outline-primary");
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span> Syncing...';

        try {
          const res = await fetch("/api/items/sync_zoho", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items: null }), // Sync all current fetch
          });
          const data = await res.json();

          if (data.status === "success") {
            alert(
              `Sync Complete!\nCreated: ${data.stats.created}\nUpdated: ${data.stats.updated}\nFailed: ${data.stats.failed}`,
            );
          } else {
            alert("Sync Error: " + data.message);
          }
        } catch (err) {
          console.error(err);
          alert("Connection Error during Sync");
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      function updateKPIs(stats) {
        if (!stats) return;
        document.getElementById("total-items").innerText =
          stats.total_items || 0;
        document.getElementById("total-categories").innerText =
          stats.categories || 0;
        document.getElementById("total-value").innerText =
          "₹" + (stats.total_value || 0).toLocaleString();
      }

      function renderTable(items) {
        const tbody = document.getElementById("tableBody");
        if (!items || items.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="8" class="text-center py-4 text-muted">No Items Found</td></tr>';
          return;
        }

        tbody.innerHTML = items
          .map(
            (i) => `
                <tr onclick="showDetails('${i.name.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                    <td class="fw-medium text-primary">${i.name}</td>
                    <td><span class="badge bg-light text-dark border">${i.group_name || i.group || "-"}</span></td>
                    <td><small class="text-muted">${i.category || "-"}</small></td>
                    <td>${i.hsn || "-"}</td>
                    <td>${i.gst_rate ? i.gst_rate + "%" : "-"}</td>
                    <td>${i.rate_of_duty ? i.rate_of_duty + "%" : "-"}</td>
                    <td>${i.qty ? i.qty + " " + (i.qty_unit || "") : "-"}</td>
                    <td class="text-end fw-bold">${i.value ? "₹" + parseFloat(i.value).toLocaleString() : "-"}</td>
                </tr>
            `,
          )
          .join("");
      }

      function showDetails(name) {
        const item = allItems.find((i) => i.name === name);
        if (!item) return;

        const html = `
                <div class="mb-4">
                    <h6 class="text-uppercase text-muted fw-bold small mb-2">Item Overview</h6>
                    <div class="mb-2"><span class="fw-bold">Name:</span> ${item.name}</div>
                    <div class="mb-2"><span class="fw-bold">Group:</span> ${item.group_name || item.group || "-"}</div>
                    <div class="mb-2"><span class="fw-bold">Category:</span> ${item.category || "-"}</div>
                    <div class="mb-2"><span class="fw-bold">Base Unit:</span> ${item.unit || "-"}</div>
                </div>

                <div class="mb-4">
                    <h6 class="text-uppercase text-muted fw-bold small mb-2">Stock & Valuation</h6>
                    <div class="row g-3">
                        <div class="col-6"><small class="text-muted">Opening Qty</small><div class="fw-bold">${item.qty || 0} ${item.qty_unit || ""}</div></div>
                        <div class="col-6"><small class="text-muted">Rate</small><div>${item.rate || 0} / ${item.rate_unit || ""}</div></div>
                        <div class="col-12 mt-2">
                            <div class="alert alert-primary d-flex justify-content-between mb-0">
                                <span>Total Value</span>
                                <span class="fw-bold fs-5">₹${item.value ? parseFloat(item.value).toLocaleString() : "0"}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="text-uppercase text-muted fw-bold small mb-2">HSN & GST Details</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>HSN / SAC</span>
                            <span class="fw-bold font-monospace">${item.hsn || "-"}</span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted d-block">Description</small>
                            <span>${item.description || "-"}</span>
                        </li>
                         <li class="list-group-item d-flex justify-content-between">
                            <span>Source of HSN</span>
                            <span class="text-muted small">${item.hsn_source || "-"}</span>
                        </li>
                    </ul>
                </div>

                <div class="mb-4">
                    <h6 class="text-uppercase text-muted fw-bold small mb-2">Tax Configuration</h6>
                    <div class="p-3 bg-light rounded border">
                        <div class="row g-2">
                            <div class="col-6"><small class="text-muted">GST Applicable</small><div>${item.gst_applicable || "-"}</div></div>
                            <div class="col-6"><small class="text-muted">Supply Type</small><div>${item.supply_type || "-"}</div></div>
                            <div class="col-6"><small class="text-muted">Taxability</small><div>${item.taxability || "-"}</div></div>
                            <div class="col-6"><small class="text-muted">GST Rate</small><div class="fw-bold text-success">${item.gst_rate ? item.gst_rate + "%" : "-"}</div></div>
                            <div class="col-12 border-top pt-2 mt-2">
                                <small class="text-muted">Rate Source: ${item.gst_rate_source || "-"}</small>
                            </div>
                             <div class="col-12 pt-2">
                                <small class="text-muted">Rate of Duty</small>
                                <div class="fw-bold fs-5 text-dark">${item.rate_of_duty ? item.rate_of_duty + "%" : "0%"}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.getElementById("offcanvasBody").innerHTML = html;
        const bsOffcanvas = new bootstrap.Offcanvas(
          document.getElementById("detailOffcanvas"),
        );
        bsOffcanvas.show();
      }

      function handleSearch() {
        const q = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allItems.filter((i) =>
          i.name.toLowerCase().includes(q),
        );
        renderTable(filtered);
      }
    </script>
  </body>
</html>
